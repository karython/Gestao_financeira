<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Financeira Pessoal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/7075/7075618.png">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

       html, body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* bloqueia completamente a barra */
        }


        /* Esconde a barra no Chrome, Edge e Safari */
        body::-webkit-scrollbar {
            display: none;
        }

        /* Esconde no Firefox */
        body {
            scrollbar-width: none;
        }

        /* Esconde no Internet Explorer e Edge antigo */
        body {
            -ms-overflow-style: none;
        }
        html {
            scrollbar-width: none;       /* Firefox */
            -ms-overflow-style: none;    /* IE e Edge antigo */
        }

        html::-webkit-scrollbar {
            display: none;               /* Chrome, Edge, Safari */
        }

        body {
            overflow-y: scroll;          /* permite rolar */
        }


        footer {
            text-align: center;
            background-color: white;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
        }

        .login-box h2 {
            margin-bottom: 30px;
            color: #333;
            text-align: center;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            background: #f5f7fa;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .sidebar-header h2 {
            font-size: 24px;
        }

        .menu-item {
            width: 100%;
            padding: 15px 20px;
            background: none;
            border: none;
            color: white;
            text-align: left;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 16px;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .menu-item.active {
            background: rgba(255,255,255,0.2);
            border-left: 4px solid white;
        }

        .main-content {
            margin-left: 250px;
            padding: 40px;
            flex: 1;
            width: calc(100% - 250px);
        }

        .hamburger {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #667eea;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            flex-direction: column;
            gap: 4px;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: white;
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card h4 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: #333;
            font-size: 28px;
            font-weight: bold;
        }

        .dashboard-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .dashboard-card h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            color: #333;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-buttons .btn {
            padding: 8px 16px;
            font-size: 12px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h3 {
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .filter-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-container select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex: 1;
            min-width: 150px;
        }

        .profile-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }

        .chart-container {
            margin-top: 20px;
        }

        .simple-chart {
            width: 100%;
            height: 400px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            width: 100%;
            height: 100%;
            gap: 10px;
            padding: 20px 0;
        }

        .bar {
            flex: 1;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px 5px 0 0;
            position: relative;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding-top: 10px;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .bar-value {
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            color: #333;
            font-size: 11px;
            text-align: center;
            width: 100%;
        }

        .hidden {
            display: none !important;
        }

        /* Loader Styles */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 1000;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 80px 20px 20px;
            }

            .hamburger {
                display: flex;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .filter-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const API_BASE = 'https://gestao-financeira-tmqc.onrender.com/api';

        // API Helper
        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('currentUser');
                        window.location.reload();
                    }
                    throw new Error(`API Error: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Auth API
        const authAPI = {
            login: (email, password) => apiRequest('/auth/login/', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            }),
            register: (userData) => apiRequest('/auth/register/', {
                method: 'POST',
                body: JSON.stringify(userData)
            }),
            getProfile: () => apiRequest('/auth/profile/'),
            updateProfile: (userData) => apiRequest('/auth/profile/', {
                method: 'PUT',
                body: JSON.stringify(userData)
            })
        };

        // Categories API
        const categoriesAPI = {
            list: () => apiRequest('/categories/'),
            create: (category) => apiRequest('/categories/', {
                method: 'POST',
                body: JSON.stringify(category)
            }),
            update: (id, category) => apiRequest(`/categories/${id}/`, {
                method: 'PUT',
                body: JSON.stringify(category)
            }),
            delete: (id) => apiRequest(`/categories/${id}/`, {
                method: 'DELETE'
            })
        };

        // Expenses API
        const expensesAPI = {
            list: (params = {}) => {
                const query = new URLSearchParams(params).toString();
                return apiRequest(`/expenses/?${query}`);
            },
            create: (expense) => apiRequest('/expenses/', {
                method: 'POST',
                body: JSON.stringify(expense)
            }),
            update: (id, expense) => apiRequest(`/expenses/${id}/`, {
                method: 'PUT',
                body: JSON.stringify(expense)
            }),
            delete: (id) => apiRequest(`/expenses/${id}/`, {
                method: 'DELETE'
            })
        };

        // Fixed Expenses API
        const fixedExpensesAPI = {
            list: () => apiRequest('/fixed-expenses/'),
            create: (expense) => apiRequest('/fixed-expenses/', {
                method: 'POST',
                body: JSON.stringify(expense)
            }),
            update: (id, expense) => apiRequest(`/fixed-expenses/${id}/`, {
                method: 'PUT',
                body: JSON.stringify(expense)
            }),
            delete: (id) => apiRequest(`/fixed-expenses/${id}/`, {
                method: 'DELETE'
            })
        };

        // Income API
        const incomeAPI = {
            get: () => apiRequest('/income/'),
            update: (income) => apiRequest('/income/', {
                method: 'PUT',
                body: JSON.stringify(income)
            }),
            listVariable: () => apiRequest('/income/variable/'),
            createVariable: (income) => apiRequest('/income/variable/', {
                method: 'POST',
                body: JSON.stringify(income)
            }),
            updateVariable: (id, income) => apiRequest(`/income/variable/${id}/`, {
                method: 'PUT',
                body: JSON.stringify(income)
            }),
            deleteVariable: (id) => apiRequest(`/income/variable/${id}/`, {
                method: 'DELETE'
            })
        };

        // Dashboard API
        const dashboardAPI = {
            stats: () => apiRequest('/dashboard/stats/'),
            recentTransactions: (limit = 10) => apiRequest(`/dashboard/recent-transactions/?limit=${limit}`),
            allTransactions: () => apiRequest('/dashboard/all-transactions/')
        };

        // Helper function to find category name
        function getCategoryName(expense, categories) {
            let categoryName = 'Sem categoria';

            if (expense.category_id) {
                const cat = categories.find(c => c.id === expense.category_id);
                if (cat) return cat.name;
            }

            if (expense.category_id) {
                const cat = categories.find(c => c.id == expense.category_id);
                if (cat) return cat.name;
            }

            if (expense.category) {
                if (typeof expense.category === 'object') {
                    return expense.category.name || 'Sem categoria';
                }
                return expense.category;
            }

            if (expense.categoryId) {
                const cat = categories.find(c => c.id == expense.categoryId);
                if (cat) return cat.name;
            }

            return categoryName;
        }

        // Helper function to format date correctly (avoid timezone issues)
        function formatDate(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(year, month - 1, day).toLocaleDateString('pt-BR');
        }

        // Helper function to get today's date in local format
        function getTodayLocal() {
            const today = new Date();
            return today.getFullYear() + '-' +
                   String(today.getMonth() + 1).padStart(2, '0') + '-' +
                   String(today.getDate()).padStart(2, '0');
        }

        // Loader functions
        function showLoader() {
            state.isLoading = true;
            const loader = document.createElement('div');
            loader.className = 'loader-overlay';
            loader.id = 'globalLoader';
            loader.innerHTML = '<div class="loader"></div>';
            document.body.appendChild(loader);
        }

        function hideLoader() {
            state.isLoading = false;
            const loader = document.getElementById('globalLoader');
            if (loader) {
                loader.remove();
            }
        }

        // App State
        const state = {
            isAuthenticated: false,
            currentUser: null,
            currentView: 'dashboard',
            sidebarOpen: false,
            isLoading: false,
            dashboardView: 'current' // 'current' or 'all'
        };

        // Initialize App
        function init() {
            const user = localStorage.getItem('currentUser');
            if (user) {
                state.currentUser = JSON.parse(user);
                state.isAuthenticated = true;
                renderApp();
            } else {
                renderLogin();
            }
        }

        // Render Login
        function renderLogin() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="login-container">
                    <div class="login-box">
                        <h2 id="loginTitle">Login</h2>
                        <form id="loginForm">
                            <div class="form-group hidden" id="nameGroup">
                                <label>Nome</label>
                                <input type="text" id="name">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="email" required placeholder="teste@email.com">
                            </div>
                            <div class="form-group">
                                <label>Senha</label>
                                <input type="password" id="password" required placeholder="123">
                            </div>
                            <div id="errorMessage" style="color: red; margin-bottom: 10px; display: none;"></div>
                            <button type="submit" class="btn" style="width: 100%; margin-bottom: 15px;">
                                <span id="submitText">Entrar</span>
                            </button>
                        </form>

                        <label>Email: teste@email.com </br>Senha:123 </label>
                        
                        

                    </div>
                </div>
            `;
                /*
                <button id="toggleMode" style="background: none; border: none; color: #667eea; cursor: pointer; width: 100%; text-align: center;">
                            Não tem conta? Cadastre-se
                        </button>
                */
            let isRegister = false;
            const nameInput = document.getElementById('name');
            
            document.getElementById('toggleMode').addEventListener('click', () => {
                isRegister = !isRegister;
                document.getElementById('loginTitle').textContent = isRegister ? 'Cadastro' : 'Login';
                document.getElementById('submitText').textContent = isRegister ? 'Cadastrar' : 'Entrar';
                document.getElementById('toggleMode').textContent = isRegister ? 'Já tem conta? Faça login' : 'Não tem conta? Cadastre-se';
                document.getElementById('nameGroup').classList.toggle('hidden', !isRegister);
                
                if (isRegister) {
                    nameInput.setAttribute('required', '');
                } else {
                    nameInput.removeAttribute('required');
                    nameInput.value = '';
                }
            });

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const errorDiv = document.getElementById('errorMessage');
                const nameInput = document.getElementById('name');

                if (isRegister && !nameInput.value.trim()) {
                    errorDiv.textContent = 'Por favor, preencha o campo nome.';
                    errorDiv.style.display = 'block';
                    nameInput.focus();
                    return;
                }

                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const name = nameInput.value;
                const submitBtn = e.target.querySelector('button[type="submit"]');

                submitBtn.disabled = true;
                errorDiv.style.display = 'none';

                try {
                    if (isRegister) {
                        await authAPI.register({ name, email, password });
                        const loginResponse = await authAPI.login(email, password);
                        localStorage.setItem('token', loginResponse.access_token);
                        const profile = await authAPI.getProfile();
                        handleLogin({ ...profile, token: loginResponse.access_token });
                    } else {
                        const response = await authAPI.login(email, password);
                        localStorage.setItem('token', response.access_token);
                        const profile = await authAPI.getProfile();
                        handleLogin({ ...profile, token: response.access_token });
                    }
                } catch (err) {
                    errorDiv.textContent = 'Erro no login/cadastro. Verifique suas credenciais.';
                    errorDiv.style.display = 'block';
                } finally {
                    submitBtn.disabled = false;
                }
            });
        }

        function handleLogin(userData) {
            localStorage.setItem('currentUser', JSON.stringify(userData));
            state.currentUser = userData;
            state.isAuthenticated = true;
            renderApp();
        }

        function handleLogout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('token');
            state.currentUser = null;
            state.isAuthenticated = false;
            state.currentView = 'dashboard';
            renderLogin();
        }

        // Render App
        function renderApp() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="app-container">
                    <button class="hamburger" id="hamburger">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="sidebar" id="sidebar">
                        <div class="sidebar-header">
                            <img src="https://cdn-icons-png.flaticon.com/512/817/817729.png" alt="Logo FinControl" width="100" height="100">
                            <h2>FinControl</h2>
                        </div>
                        <button class="menu-item" data-view="dashboard">Dashboard</button>
                        <button class="menu-item" data-view="categories">Categorias</button>
                        <button class="menu-item" data-view="expenses">Lançamentos</button>
                        <button class="menu-item" data-view="fixedExpenses">Despesas Fixas</button>
                        <button class="menu-item" data-view="income">Receitas</button>
                        <button class="menu-item" data-view="reports">Relatórios</button>
                        <button class="menu-item" data-view="analysis">Análises</button>
                        <button class="menu-item" data-view="settings">Configurações</button>
                        <button class="menu-item" id="logoutBtn">Sair</button>
                    </div>
                    
                    <div class="main-content" id="mainContent"></div>
                </div>
            `;

            document.getElementById('hamburger').addEventListener('click', () => {
                state.sidebarOpen = !state.sidebarOpen;
                document.getElementById('sidebar').classList.toggle('active', state.sidebarOpen);
            });

            document.querySelectorAll('.menu-item[data-view]').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.currentView = btn.dataset.view;
                    renderMainContent();
                    updateActiveMenu();
                    if (window.innerWidth <= 768) {
                        state.sidebarOpen = false;
                        document.getElementById('sidebar').classList.remove('active');
                    }
                });
            });

            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            updateActiveMenu();
            renderMainContent();
        }

        function updateActiveMenu() {
            document.querySelectorAll('.menu-item[data-view]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === state.currentView);
            });
        }

        function renderMainContent() {
            const content = document.getElementById('mainContent');
            
            switch(state.currentView) {
                case 'dashboard':
                    renderDashboard(content);
                    break;
                case 'categories':
                    renderCategories(content);
                    break;
                case 'expenses':
                    renderExpenses(content);
                    break;
                case 'fixedExpenses':
                    renderFixedExpenses(content);
                    break;
                case 'income':
                    renderIncome(content);
                    break;
                case 'reports':
                    renderReports(content);
                    break;
                case 'analysis':
                    renderAnalysis(content);
                    break;
                case 'settings':
                    renderSettings(content);
                    break;
            }
        }

        // Dashboard
        async function renderDashboard(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Dashboard</h1>
                <div style="margin-bottom: 20px;">
                    <button class="btn ${state.dashboardView === 'current' ? 'btn-secondary' : ''}" id="currentMonthBtn">Mês Atual</button>
                    <button class="btn ${state.dashboardView === 'all' ? 'btn-secondary' : ''}" id="allTransactionsBtn">Histórico</button>
                </div>
                <div id="dashboardContent">Carregando...</div>
            `;

            document.getElementById('currentMonthBtn').addEventListener('click', () => {
                state.dashboardView = 'current';
                renderDashboard(content);
            });

            document.getElementById('allTransactionsBtn').addEventListener('click', () => {
                state.dashboardView = 'all';
                renderDashboard(content);
            });

            showLoader();

            try {
                const [statsData, transactions] = await Promise.all([
                    dashboardAPI.stats(),
                    state.dashboardView === 'current' ? dashboardAPI.recentTransactions() : dashboardAPI.allTransactions()
                ]);

                const stats = {
                    total_balance: parseFloat(statsData.total_balance),
                    monthly_income: parseFloat(statsData.monthly_income),
                    monthly_expenses: parseFloat(statsData.monthly_expenses),
                    active_categories: statsData.active_categories,
                    transactions: transactions
                };

                const dashContent = document.getElementById('dashboardContent');
                dashContent.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>Saldo Total</h4>
                            <div class="value">R$ ${stats.total_balance.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Receita Mensal</h4>
                            <div class="value">R$ ${stats.monthly_income.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Despesas Mensal</h4>
                            <div class="value">R$ ${stats.monthly_expenses.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Categorias Ativas</h4>
                            <div class="value">${stats.active_categories}</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <h3>${state.dashboardView === 'current' ? 'Transações do Mês Atual' : 'Histórico de Transações'}</h3>
                        ${stats.transactions.length > 0 ? `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Descrição</th>
                                            <th>Tipo</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${stats.transactions.map(expense => `
                                            <tr>
                                                <td>${new Date(expense.date).toLocaleDateString('pt-BR')}</td>
                                                <td>${expense.description}</td>
                                                <td>
                                                    <span class="badge ${expense.type.toUpperCase() === 'RECEITA' ? 'badge-success' : 'badge-danger'}">
                                                        ${expense.type.toUpperCase()}
                                                    </span>
                                                </td>
                                                <td>R$ ${parseFloat(expense.amount).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="empty-state"><p>Nenhuma transação encontrada</p></div>'}
                    </div>
                `;
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                document.getElementById('dashboardContent').innerHTML = '<p>Erro ao carregar dados do dashboard</p>';
            } finally {
                hideLoader();
            }
        }

        // Categories
        async function renderCategories(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Categorias</h1>
                <button class="btn" id="newCategoryBtn" style="margin-bottom: 20px;">Nova Categoria</button>
                <div class="dashboard-card">
                    <h3>Lista de Categorias</h3>
                    <div id="categoriesContent">Carregando...</div>
                </div>
            `;

            document.getElementById('newCategoryBtn').addEventListener('click', () => showCategoryModal());

            showLoader();
            await loadCategories();
            hideLoader();
        }

        async function loadCategories() {
            try {
                const categories = await categoriesAPI.list();
                
                const categoriesContent = document.getElementById('categoriesContent');

                if (categories.length > 0) {
                    categoriesContent.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Tipo</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${categories.map(category => `
                                        <tr>
                                            <td>${category.name}</td>
                                            <td>
                                                <span class="badge ${category.type.toUpperCase() === 'RECEITA' ? 'badge-success' : 'badge-danger'}">
                                                    ${category.type.toUpperCase()}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn btn-secondary" onclick="editCategory(${category.id}, '${category.name}', '${category.type.toUpperCase()}')">Editar</button>
                                                    <button class="btn btn-danger" onclick="deleteCategory(${category.id})">Excluir</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    categoriesContent.innerHTML = '<div class="empty-state"><p>Nenhuma categoria cadastrada</p></div>';
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                document.getElementById('categoriesContent').innerHTML = '<p>Erro ao carregar categorias</p>';
            }
        }

        function showCategoryModal(id = null, name = '', type = 'DESPESA') {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>${id ? 'Editar Categoria' : 'Nova Categoria'}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <form id="categoryForm">
                        <div class="form-group">
                            <label>Nome da Categoria</label>
                            <input type="text" id="categoryName" required value="${name}">
                        </div>
                        <div class="form-group">
                            <label>Tipo</label>
                            <select id="categoryType">
                                <option value="DESPESA" ${type === 'DESPESA' ? 'selected' : ''}>Despesa</option>
                                <option value="RECEITA" ${type === 'RECEITA' ? 'selected' : ''}>Receita</option>
                            </select>
                        </div>
                        <button type="submit" class="btn">${id ? 'Salvar' : 'Adicionar'}</button>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            document.getElementById('categoryForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = {
                    name: document.getElementById('categoryName').value,
                    type: document.getElementById('categoryType').value
                };

                try {
                    if (id) {
                        await categoriesAPI.update(id, formData);
                    } else {
                        await categoriesAPI.create(formData);
                    }
                    modal.remove();
                    loadCategories();
                } catch (error) {
                    alert('Erro ao salvar categoria');
                }
            });
        }

        window.editCategory = (id, name, type) => showCategoryModal(id, name, type);

        window.deleteCategory = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta categoria?')) {
                try {
                    await categoriesAPI.delete(id);
                    loadCategories();
                } catch (error) {
                    alert('Erro ao excluir categoria');
                }
            }
        };

        // Expenses
        async function renderExpenses(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Lançamentos</h1>
                <button class="btn" id="newExpenseBtn" style="margin-bottom: 20px;">Novo Lançamento</button>
                <div class="dashboard-card">
                    <h3>Lista de Lançamentos</h3>
                    <div id="expensesContent">Carregando...</div>
                </div>
            `;

            document.getElementById('newExpenseBtn').addEventListener('click', () => showExpenseModal());
            showLoader();
            await loadExpenses();
            hideLoader();
        }

        async function loadExpenses() {
            try {
                const [expenses, categories] = await Promise.all([
                    expensesAPI.list(),
                    categoriesAPI.list()
                ]);

                const expensesContent = document.getElementById('expensesContent');

                if (expenses.length > 0) {
                    expensesContent.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Descrição</th>
                                        <th>Categoria</th>
                                        <th>Tipo</th>
                                        <th>Valor</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${expenses.map(expense => {
                                        const categoryName = getCategoryName(expense, categories);
                                        
                                        return `
                                            <tr>
                                                <td>${new Date(expense.date).toLocaleDateString('pt-BR')}</td>
                                                <td>${expense.description}</td>
                                                <td>${categoryName}</td>
                                                <td>
                                                    <span class="badge ${expense.type.toUpperCase() === 'RECEITA' ? 'badge-success' : 'badge-danger'}">
                                                        ${expense.type.toUpperCase()}
                                                    </span>
                                                </td>
                                                <td>R$ ${parseFloat(expense.amount).toFixed(2)}</td>
                                                <td>
                                                    <div class="action-buttons">
                                                        <button class="btn btn-secondary" onclick="editExpense(${expense.id})">Editar</button>
                                                        <button class="btn btn-danger" onclick="deleteExpense(${expense.id})">Excluir</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    expensesContent.innerHTML = '<div class="empty-state"><p>Nenhum lançamento cadastrado</p></div>';
                }

                window.expensesData = expenses;
                window.categoriesData = categories;
            } catch (error) {
                console.error('Erro ao carregar expenses:', error);
                document.getElementById('expensesContent').innerHTML = '<p>Erro ao carregar lançamentos</p>';
            }
        }

        async function showExpenseModal(expenseData = null) {
            try {
                // Mostrar loading
                const loadingModal = document.createElement('div');
                loadingModal.className = 'modal-overlay';
                loadingModal.innerHTML = `
                    <div class="modal">
                        <div style="text-align: center; padding: 40px;">
                            <p>Carregando categorias...</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(loadingModal);

                // Carregar categorias antes de abrir a modal
                const categories = await categoriesAPI.list();
                
               
                
                // Remover loading
                loadingModal.remove();
                
                if (!categories || categories.length === 0) {
                    alert('Nenhuma categoria encontrada. Por favor, cadastre categorias primeiro.');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <h3>${expenseData ? 'Editar Lançamento' : 'Novo Lançamento'}</h3>
                            <button class="close-btn">&times;</button>
                        </div>
                        <form id="expenseForm">
                            <div class="form-group">
                                <label>Descrição</label>
                                <input type="text" id="expenseDescription" required value="${expenseData?.description || ''}">
                            </div>
                            <div class="form-group">
                                <label>Valor</label>
                                <input type="number" step="0.01" id="expenseAmount" required value="${expenseData?.amount || ''}">
                            </div>
                            <div class="form-group">
                                <label>Tipo</label>
                                <select id="expenseType">
                                    <option value="DESPESA" ${!expenseData || expenseData?.type === 'DESPESA' ? 'selected' : ''}>Despesa</option>
                                    <option value="RECEITA" ${expenseData?.type === 'RECEITA' ? 'selected' : ''}>Receita</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Categoria</label>
                                <select id="expenseCategory" required>
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Data</label>
                                <input type="date" id="expenseDate" required value="${expenseData?.date || getTodayLocal()}">
                            </div>
                            <button type="submit" class="btn">${expenseData ? 'Salvar' : 'Adicionar'}</button>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                const typeSelect = document.getElementById('expenseType');
                const categorySelect = document.getElementById('expenseCategory');

                function updateCategories() {
                    const type = typeSelect.value;

                    // Filtrar comparando com minúsculas pois a API retorna 'despesa' e 'receita'
                    const filteredCategories = categories.filter(c => c.type.toUpperCase() === type);
       
                    
                    categorySelect.innerHTML = '<option value="">Selecione...</option>' +
                        filteredCategories.map(c => {
                            const selected = expenseData?.category_id == c.id ? 'selected' : '';
                            return `<option value="${c.id}" ${selected}>${c.name}</option>`;
                        }).join('');
                    

                }

                typeSelect.addEventListener('change', updateCategories);
                // Inicializar categorias
                updateCategories();

                modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });

                document.getElementById('expenseForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = {
                        description: document.getElementById('expenseDescription').value,
                        amount: parseFloat(document.getElementById('expenseAmount').value),
                        category_id: parseInt(document.getElementById('expenseCategory').value),
                        date: document.getElementById('expenseDate').value,
                        type: document.getElementById('expenseType').value.toLowerCase()
                    };

                    

                    try {
                        if (expenseData) {
                            await expensesAPI.update(expenseData.id, formData);
                        } else {
                            await expensesAPI.create(formData);
                        }
                        modal.remove();
                        loadExpenses();
                    } catch (error) {
                        console.error('Erro ao salvar:', error);
                        alert('Erro ao salvar lançamento');
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                alert('Erro ao carregar categorias. Tente novamente.');
            }
        }

        window.editExpense = async (id) => {
            const expense = window.expensesData.find(e => e.id === id);
            if (expense) showExpenseModal(expense);
        };

        window.deleteExpense = async (id) => {
            if (confirm('Tem certeza que deseja excluir este lançamento?')) {
                try {
                    await expensesAPI.delete(id);
                    loadExpenses();
                } catch (error) {
                    alert('Erro ao excluir lançamento');
                }
            }
        };

        // Fixed Expenses
        async function renderFixedExpenses(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Despesas Fixas</h1>
                <button class="btn" id="newFixedExpenseBtn" style="margin-bottom: 20px;">Nova Despesa Fixa</button>
                <div class="dashboard-card">
                    <h3>Lista de Despesas Fixas</h3>
                    <div id="fixedExpensesContent">Carregando...</div>
                </div>
            `;

            document.getElementById('newFixedExpenseBtn').addEventListener('click', () => showFixedExpenseModal());
            showLoader();
            await loadFixedExpenses();
            hideLoader();
        }

        async function loadFixedExpenses() {
            try {
                const [fixedExpenses, categories] = await Promise.all([
                    fixedExpensesAPI.list(),
                    categoriesAPI.list()
                ]);

                const expensesContent = document.getElementById('fixedExpensesContent');
                
                if (!expensesContent) {
                    console.error('Elemento fixedExpensesContent não encontrado');
                    return;
                }

                if (fixedExpenses.length > 0) {
                    expensesContent.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Descrição</th>
                                        <th>Categoria</th>
                                        <th>Valor</th>
                                        <th>Dia do Mês</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${fixedExpenses.map(expense => {
                                        const categoryName = getCategoryName(expense, categories);
                                        
                                        return `
                                            <tr>
                                                <td>${expense.description}</td>
                                                <td>${categoryName}</td>
                                                <td>R$ ${parseFloat(expense.amount).toFixed(2)}</td>
                                                <td>Dia ${expense.day_of_month}</td>
                                                <td>
                                                    <div class="action-buttons">
                                                        <button class="btn btn-secondary" onclick="editFixedExpense(${expense.id})">Editar</button>
                                                        <button class="btn btn-danger" onclick="deleteFixedExpense(${expense.id})">Excluir</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    expensesContent.innerHTML = '<div class="empty-state"><p>Nenhuma despesa fixa cadastrada</p></div>';
                }

                window.fixedExpensesData = fixedExpenses;
                window.fixedCategoriesData = categories;
            } catch (error) {
                console.error('Erro ao carregar despesas fixas:', error);
                const expensesContent = document.getElementById('fixedExpensesContent');
                if (expensesContent) {
                    expensesContent.innerHTML = '<p>Erro ao carregar despesas fixas</p>';
                }
            }
        }

        async function showFixedExpenseModal(expenseData = null) {
            try {
                // Mostrar loading
                const loadingModal = document.createElement('div');
                loadingModal.className = 'modal-overlay';
                loadingModal.innerHTML = `
                    <div class="modal">
                        <div style="text-align: center; padding: 40px;">
                            <p>Carregando categorias...</p>
                        </div>
                    </div>
                `;
                document.body.appendChild(loadingModal);

                // Carregar categorias antes de abrir a modal
                const categories = await categoriesAPI.list();
                
       
                
                // Remover loading
                loadingModal.remove();
                
                // Filtrar categorias de despesa (comparar com maiúsculas pois a API retorna minúsculo)
                const despesaCategories = categories.filter(c => c.type.toUpperCase() === 'DESPESA');
                
               
                
                if (despesaCategories.length === 0) {
                    alert('Nenhuma categoria de despesa encontrada. Por favor, cadastre categorias de despesa primeiro.');
                    return;
                }
                
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal">
                        <div class="modal-header">
                            <h3>${expenseData ? 'Editar Despesa Fixa' : 'Nova Despesa Fixa'}</h3>
                            <button class="close-btn">&times;</button>
                        </div>
                        <form id="fixedExpenseForm">
                            <div class="form-group">
                                <label>Descrição</label>
                                <input type="text" id="fixedExpenseDescription" required value="${expenseData?.description || ''}">
                            </div>
                            <div class="form-group">
                                <label>Valor</label>
                                <input type="number" step="0.01" id="fixedExpenseAmount" required value="${expenseData?.amount || ''}">
                            </div>
                            <div class="form-group">
                                <label>Categoria</label>
                                <select id="fixedExpenseCategory" required>
                                    <option value="">Selecione...</option>
                                    ${despesaCategories.map(c => {
                                        const selected = expenseData?.category_id == c.id ? 'selected' : '';
                                        return `<option value="${c.id}" ${selected}>${c.name}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Dia do Mês (1-31)</label>
                                <input type="number" min="1" max="31" id="fixedExpenseDay" required value="${expenseData?.day_of_month || ''}">
                            </div>
                            <button type="submit" class="btn">${expenseData ? 'Salvar' : 'Adicionar'}</button>
                        </form>
                    </div>
                `;

                document.body.appendChild(modal);

                modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });

                document.getElementById('fixedExpenseForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = {
                        description: document.getElementById('fixedExpenseDescription').value,
                        amount: parseFloat(document.getElementById('fixedExpenseAmount').value),
                        category_id: parseInt(document.getElementById('fixedExpenseCategory').value),
                        day_of_month: parseInt(document.getElementById('fixedExpenseDay').value)
                    };

                  

                    try {
                        if (expenseData) {
                            await fixedExpensesAPI.update(expenseData.id, formData);
                        } else {
                            await fixedExpensesAPI.create(formData);
                        }
                        modal.remove();
                        loadFixedExpenses();
                    } catch (error) {
                        console.error('Erro ao salvar:', error);
                        alert('Erro ao salvar despesa fixa');
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                alert('Erro ao carregar categorias. Tente novamente.');
            }
        }

        window.editFixedExpense = (id) => {
            const expense = window.fixedExpensesData.find(e => e.id === id);
            if (expense) showFixedExpenseModal(expense);
        };

        window.deleteFixedExpense = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta despesa fixa?')) {
                try {
                    await fixedExpensesAPI.delete(id);
                    loadFixedExpenses();
                } catch (error) {
                    alert('Erro ao excluir despesa fixa');
                }
            }
        };

        // Income
        async function renderIncome(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Receitas</h1>
                <div id="incomeContent">Carregando...</div>
            `;

            showLoader();
            await loadIncome();
            hideLoader();
        }

        async function loadIncome() {
            try {
                const [incomeData, variableIncomes] = await Promise.all([
                    incomeAPI.get(),
                    incomeAPI.listVariable()
                ]);

                const totalVariable = variableIncomes.reduce((sum, v) => sum + parseFloat(v.amount), 0);
                const totalIncome = parseFloat(incomeData.fixed_amount) + totalVariable;

                const incomeContent = document.getElementById('incomeContent');
                incomeContent.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>Receita Total Líquida</h4>
                            <div class="value">R$ ${totalIncome.toFixed(2)}</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <h3>Receita Mensal Fixa</h3>
                        <div class="form-group">
                            <label>Valor Fixo Mensal</label>
                            <input type="number" step="0.01" id="fixedIncomeInput" value="${incomeData.fixed_amount}" placeholder="0.00">
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <h3>Receitas Variáveis</h3>
                        <button class="btn" id="newVariableIncomeBtn" style="margin-bottom: 20px;">Adicionar Receita Variável</button>
                        <div id="variableIncomesContent"></div>
                    </div>
                `;

                let debounceTimer;
                document.getElementById('fixedIncomeInput').addEventListener('input', (e) => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(async () => {
                        try {
                            await incomeAPI.update({
                                fixed_amount: parseFloat(e.target.value) || 0,
                                bonus_amount: incomeData.bonus_amount || 0
                            });
                            loadIncome();
                        } catch (error) {
                            alert('Erro ao atualizar receita fixa');
                        }
                    }, 1000);
                });

                document.getElementById('newVariableIncomeBtn').addEventListener('click', () => showVariableIncomeModal());

                const variableContent = document.getElementById('variableIncomesContent');
                if (variableIncomes.length > 0) {
                    variableContent.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Descrição</th>
                                        <th>Valor</th>
                                        <th>Válido Até</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${variableIncomes.map(variable => `
                                        <tr>
                                            <td>${variable.description}</td>
                                            <td>R$ ${parseFloat(variable.amount).toFixed(2)}</td>
                                            <td>${variable.valid_until ? new Date(variable.valid_until).toLocaleDateString('pt-BR') : 'Indefinido'}</td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn btn-secondary" onclick="editVariableIncome(${variable.id})">Editar</button>
                                                    <button class="btn btn-danger" onclick="deleteVariableIncome(${variable.id})">Excluir</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    variableContent.innerHTML = '<div class="empty-state"><p>Nenhuma receita variável cadastrada</p></div>';
                }

                window.variableIncomesData = variableIncomes;
            } catch (error) {
                console.error('Erro ao carregar receitas:', error);
                document.getElementById('incomeContent').innerHTML = '<p>Erro ao carregar receitas</p>';
            }
        }

        function showVariableIncomeModal(incomeData = null) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <h3>${incomeData ? 'Editar Receita Variável' : 'Nova Receita Variável'}</h3>
                        <button class="close-btn">&times;</button>
                    </div>
                    <form id="variableIncomeForm">
                        <div class="form-group">
                            <label>Descrição</label>
                            <input type="text" id="variableIncomeDescription" required value="${incomeData?.description || ''}">
                        </div>
                        <div class="form-group">
                            <label>Valor</label>
                            <input type="number" step="0.01" id="variableIncomeAmount" required value="${incomeData?.amount || ''}">
                        </div>
                        <div class="form-group">
                            <label>Válido Até</label>
                            <input type="date" id="variableIncomeValidUntil" value="${incomeData?.valid_until || ''}">
                        </div>
                        <button type="submit" class="btn">${incomeData ? 'Salvar' : 'Adicionar'}</button>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });

            document.getElementById('variableIncomeForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = {
                    description: document.getElementById('variableIncomeDescription').value,
                    amount: parseFloat(document.getElementById('variableIncomeAmount').value),
                    valid_until: document.getElementById('variableIncomeValidUntil').value,
                    is_active: true
                };

                try {
                    if (incomeData) {
                        await incomeAPI.updateVariable(incomeData.id, formData);
                    } else {
                        await incomeAPI.createVariable(formData);
                    }
                    modal.remove();
                    loadIncome();
                } catch (error) {
                    alert('Erro ao salvar receita variável');
                }
            });
        }

        window.editVariableIncome = (id) => {
            const income = window.variableIncomesData.find(i => i.id === id);
            if (income) showVariableIncomeModal(income);
        };

        window.deleteVariableIncome = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta receita variável?')) {
                try {
                    await incomeAPI.deleteVariable(id);
                    loadIncome();
                } catch (error) {
                    alert('Erro ao excluir receita variável');
                }
            }
        };

        // Reports
        async function renderReports(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Relatórios</h1>

                <div class="dashboard-card">
                    <h3>Configurações do Relatório</h3>
                    <div class="filter-container">
                        <select id="reportType">
                            <option value="mensal">Mensal</option>
                            <option value="anual">Anual</option>
                            <option value="personalizado">Personalizado</option>
                        </select>
                        <select id="categoryFilter">
                            <option value="all">Todas as Categorias</option>
                        </select>
                        <input type="date" id="startDate" placeholder="Data início" style="display: none;">
                        <input type="date" id="endDate" placeholder="Data fim" style="display: none;">
                        <button class="btn" id="generateReportBtn">Gerar Relatório</button>
                    </div>
                </div>

                <div id="reportContent"></div>
            `;

            showLoader();
            try {
                const categories = await categoriesAPI.list();
                const categoryFilter = document.getElementById('categoryFilter');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    categoryFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            } finally {
                hideLoader();
            }

            // Event listener para mostrar/ocultar campos de data
            document.getElementById('reportType').addEventListener('change', function() {
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');
                if (this.value === 'personalizado') {
                    startDateInput.style.display = 'block';
                    endDateInput.style.display = 'block';
                    startDateInput.required = true;
                    endDateInput.required = true;
                } else {
                    startDateInput.style.display = 'none';
                    endDateInput.style.display = 'none';
                    startDateInput.required = false;
                    endDateInput.required = false;
                    startDateInput.value = '';
                    endDateInput.value = '';
                }
            });

            document.getElementById('generateReportBtn').addEventListener('click', generateReport);
        }

        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const reportContent = document.getElementById('reportContent');

            // Validação para relatório personalizado
            if (reportType === 'personalizado') {
                if (!startDate || !endDate) {
                    alert('Por favor, selecione as datas de início e fim para o relatório personalizado.');
                    return;
                }
                if (new Date(startDate) > new Date(endDate)) {
                    alert('A data de início não pode ser posterior à data de fim.');
                    return;
                }
            }

            reportContent.innerHTML = '<div class="dashboard-card"><p>Gerando relatório...</p></div>';
            showLoader();

            try {
                // Preparar parâmetros para a API
                const params = new URLSearchParams();
                params.append('type', reportType);

                if (categoryFilter !== 'all') {
                    params.append('category_id', categoryFilter);
                }

                const now = new Date();
                if (reportType === 'mensal') {
                    params.append('month', now.getMonth() + 1);
                    params.append('year', now.getFullYear());
                } else if (reportType === 'anual') {
                    params.append('year', now.getFullYear());
                } else if (reportType === 'personalizado') {
                    params.append('start_date', startDate);
                    params.append('end_date', endDate);
                }

                // Chamar API do backend
                const reportData = await apiRequest(`/reports/generate/?${params.toString()}`);

                // Carregar categorias para exibir nomes
                const categories = await categoriesAPI.list();

                const period = reportType === 'mensal'
                    ? now.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })
                    : reportType === 'anual'
                    ? now.getFullYear()
                    : `${new Date(startDate).toLocaleDateString('pt-BR')} - ${new Date(endDate).toLocaleDateString('pt-BR')}`;

                reportContent.innerHTML = `
                    <div class="dashboard-card">
                        <h3>Relatório ${reportType === 'mensal' ? 'Mensal' : reportType === 'anual' ? 'Anual' : 'Personalizado'} - ${period}</h3>

                        <div class="stats-grid" style="margin-bottom: 30px;">
                            <div class="stat-card">
                                <h4>Receita Total</h4>
                                <div class="value">R$ ${parseFloat(reportData.total_income).toFixed(2)}</div>
                            </div>
                            <div class="stat-card">
                                <h4>Despesas Total</h4>
                                <div class="value">R$ ${parseFloat(reportData.total_expense).toFixed(2)}</div>
                            </div>
                            <div class="stat-card">
                                <h4>Saldo</h4>
                                <div class="value" style="color: ${parseFloat(reportData.balance) >= 0 ? '#28a745' : '#dc3545'}">
                                    R$ ${parseFloat(reportData.balance).toFixed(2)}
                                </div>
                            </div>
                        </div>

                        <div class="action-buttons" style="margin-bottom: 20px;">
                            <button class="btn btn-success" id="downloadPdfBtn">Baixar PDF</button>
                            <button class="btn" id="sendEmailBtn">Enviar por Email</button>
                        </div>

                        ${reportData.transactions.length > 0 ? `
                            <h4 style="color: #333; margin-bottom: 15px;">Transações do Período</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Descrição</th>
                                            <th>Categoria</th>
                                            <th>Tipo</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${reportData.transactions.map(transaction => {
                                            const categoryName = transaction.category_id ? getCategoryName({ category_id: transaction.category_id }, categories) : 'N/A';

                                            return `
                                                <tr>
                                                    <td>${new Date(transaction.date).toLocaleDateString('pt-BR')}</td>
                                                    <td>${transaction.description}</td>
                                                    <td>${categoryName}</td>
                                                    <td>
                                                        <span class="badge ${transaction.type.toUpperCase() === 'RECEITA' ? 'badge-success' : 'badge-danger'}">
                                                            ${transaction.type.toUpperCase()}
                                                        </span>
                                                    </td>
                                                    <td>R$ ${parseFloat(transaction.amount).toFixed(2)}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="empty-state"><p>Nenhuma transação encontrada para este período</p></div>'}
                    </div>
                `;

                // Armazenar dados para PDF e email
                window.currentReportData = {
                    ...reportData,
                    period,
                    reportType,
                    startDate,
                    endDate,
                    categoryFilter
                };

                document.getElementById('downloadPdfBtn').addEventListener('click', downloadReportPDF);
                document.getElementById('sendEmailBtn').addEventListener('click', sendReportEmail);

            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                reportContent.innerHTML = '<div class="dashboard-card"><p style="color: red;">Erro ao gerar relatório. Verifique se o backend está rodando.</p></div>';
            } finally {
                hideLoader();
            }
        }

        function downloadReportPDF() {
            const reportData = window.currentReportData;
            if (!reportData) {
                alert('Nenhum relatório gerado para baixar.');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(20);
                doc.text('Relatório Financeiro', 20, 20);

                doc.setFontSize(12);
                doc.text(`Período: ${reportData.period}`, 20, 35);
                doc.text(`Receita Total: R$ ${parseFloat(reportData.total_income).toFixed(2)}`, 20, 45);
                doc.text(`Despesas Total: R$ ${parseFloat(reportData.total_expense).toFixed(2)}`, 20, 55);
                doc.text(`Saldo: R$ ${parseFloat(reportData.balance).toFixed(2)}`, 20, 65);

                let y = 80;

                doc.text('Transações:', 20, y);
                y += 10;

                reportData.transactions.forEach(transaction => {
                    const line = `${new Date(transaction.date).toLocaleDateString('pt-BR')} - ${transaction.description}: R$ ${parseFloat(transaction.amount).toFixed(2)} (${transaction.type})`;

                    if (line.length > 80) {
                        const lines = doc.splitTextToSize(line, 170);
                        lines.forEach(l => {
                            if (y > 280) {
                                doc.addPage();
                                y = 20;
                            }
                            doc.text(l, 20, y);
                            y += 7;
                        });
                    } else {
                        if (y > 280) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.text(line, 20, y);
                        y += 10;
                    }
                });

                doc.save(`relatorio-${reportData.reportType}-${Date.now()}.pdf`);
                alert('PDF baixado com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF. Verifique se a biblioteca jsPDF está carregada.');
            }
        }

        async function sendReportEmail() {
            const reportData = window.currentReportData;
            if (!reportData) {
                alert('Nenhum relatório gerado para enviar.');
                return;
            }

            const email = prompt('Digite o email para enviar o relatório:');
            if (!email) return;

            try {
                showLoader();

                // Preparar dados para envio
                const emailData = {
                    type: reportData.reportType,
                    email: email,
                    month: reportData.reportType === 'mensal' ? new Date().getMonth() + 1 : null,
                    year: reportData.reportType === 'mensal' || reportData.reportType === 'anual' ? new Date().getFullYear() : null,
                    start_date: reportData.startDate || null,
                    end_date: reportData.endDate || null,
                    category_id: reportData.categoryFilter !== 'all' ? parseInt(reportData.categoryFilter) : null
                };

                await apiRequest('/reports/email/', {
                    method: 'POST',
                    body: JSON.stringify(emailData)
                });

                alert('Relatório enviado por email com sucesso!');
            } catch (error) {
                console.error('Erro ao enviar email:', error);
                alert('Erro ao enviar relatório por email.');
            } finally {
                hideLoader();
            }
        }

        // Analysis
        function renderAnalysis(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Análises</h1>
                <div class="dashboard-card">
                    <h3>Em desenvolvimento</h3>
                    <p>Funcionalidade de análises será implementada em breve.</p>
                </div>
            `;
        }

        // Settings
        function renderSettings(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Configurações</h1>

                <div class="dashboard-card">
                    <h3>Perfil do Usuário</h3>
                    <div class="profile-section">
                        <div class="profile-avatar">
                            ${state.currentUser?.name?.charAt(0).toUpperCase() || 'U'}
                        </div>
                        <div style="flex: 1;">
                            <h2 style="color: #333; margin-bottom: 10px;">${state.currentUser?.name || 'Usuário'}</h2>
                            <p style="color: #666;">${state.currentUser?.email || 'email@exemplo.com'}</p>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3>Editar Informações</h3>
                    <form id="settingsForm">
                        <div class="form-group">
                            <label>Nome</label>
                            <input type="text" id="settingsName" value="${state.currentUser?.name || ''}">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="settingsEmail" value="${state.currentUser?.email || ''}">
                        </div>
                        <div class="form-group">
                            <label>Nova Senha (deixe em branco para manter a atual)</label>
                            <input type="password" id="settingsPassword" placeholder="Nova senha">
                        </div>
                        <button type="submit" class="btn">Salvar Alterações</button>
                    </form>
                </div>
            `;

            document.getElementById('settingsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoader();

                try {
                    const updatedUser = {
                        ...state.currentUser,
                        name: document.getElementById('settingsName').value,
                        email: document.getElementById('settingsEmail').value
                    };

                    // Simular atualização no backend
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                    state.currentUser = updatedUser;
                    alert('Configurações salvas com sucesso!');
                    renderSettings(content);
                } catch (error) {
                    alert('Erro ao salvar configurações');
                } finally {
                    hideLoader();
                }
            });
        }

        // Initialize
        init();
    </script>
    <footer >
        Todos os Direitos reservados © Desenvolvido por <a href="https://karythongomes.com.br" target="_blank" rel="noopener noreferrer"><strong>GomesTechnology</strong></a>
    </footer>
</body>
</html>
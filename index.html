<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Financeira Pessoal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/7075/7075618.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: auto; /* permite rolar se necessário */
        }


        /* Esconde a barra no Chrome, Edge e Safari */
        body::-webkit-scrollbar {
            display: none;
        }

        /* Esconde no Firefox */
        body {
            scrollbar-width: none;
        }

        /* Esconde no Internet Explorer e Edge antigo */
        body {
            -ms-overflow-style: none;
        }
        html {
            scrollbar-width: none;       /* Firefox */
            -ms-overflow-style: none;    /* IE e Edge antigo */
        }

        html::-webkit-scrollbar {
            display: none;               /* Chrome, Edge, Safari */
        }

        body {
            overflow-y: scroll;          /* permite rolar */
        }


        footer {
            text-align: center;
            background-color: white;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 400px;
            width: 100%;
        }

        .login-box h2 {
            margin-bottom: 30px;
            color: #333;
            text-align: center;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
            background: #f5f7fa;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 0 20px 30px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .sidebar-header h2 {
            font-size: 24px;
        }

        .menu-item {
            width: 100%;
            padding: 15px 20px;
            background: none;
            border: none;
            color: white;
            text-align: left;
            cursor: pointer;
            transition: background 0.3s;
            font-size: 16px;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .menu-item.active {
            background: rgba(255,255,255,0.2);
            border-left: 4px solid white;
        }

        .main-content {
            margin-left: 250px;
            padding: 40px;
            flex: 1;
            width: calc(100% - 250px);
        }

        .hamburger {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #667eea;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            flex-direction: column;
            gap: 4px;
        }

        .hamburger span {
            width: 25px;
            height: 3px;
            background: white;
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card h4 {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            color: #333;
            font-size: 28px;
            font-weight: bold;
        }

        .dashboard-card {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .dashboard-card h3 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            color: #333;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }

        table td {
            padding: 12px;
            border-bottom: 1px solid #dee2e6;
        }

        table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-buttons .btn {
            padding: 8px 16px;
            font-size: 12px;
        }

        .modal-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            background: rgba(0,0,0,0.5) !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            z-index: 999999 !important;
            opacity: 1 !important;
            visibility: visible !important;
            pointer-events: auto !important;
        }

        .modal {
            position: relative !important;
            background: white !important;
            padding: 30px !important;
            border-radius: 10px !important;
            max-width: 500px !important;
            width: 90% !important;
            max-height: 90vh !important;
            overflow-y: auto !important;
            z-index: 100000 !important;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h3 {
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .close-btn:hover {
            color: #333;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .filter-container {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-container select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex: 1;
            min-width: 150px;
        }

        .profile-section {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 32px;
            font-weight: bold;
        }

        .chart-container {
            margin-top: 20px;
        }

        .simple-chart {
            width: 100%;
            height: 400px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            width: 100%;
            height: 100%;
            gap: 10px;
            padding: 20px 0;
        }

        .bar {
            flex: 1;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px 5px 0 0;
            position: relative;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding-top: 10px;
        }

        .bar:hover {
            opacity: 0.8;
        }

        .bar-value {
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .bar-label {
            position: absolute;
            bottom: -25px;
            color: #333;
            font-size: 11px;
            text-align: center;
            width: 100%;
        }

        .hidden {
            display: none !important;
        }

        /* Loader Styles */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 1000;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 80px 20px 20px;
            }

            .hamburger {
                display: flex;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }

            .filter-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api';

        // API Helper
        async function apiRequest(endpoint, options = {}) {
            const token = localStorage.getItem('token');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };

            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        localStorage.removeItem('token');
                        localStorage.removeItem('currentUser');
                        window.location.reload();
                    }
                    throw new Error(`API Error: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Auth API
        const authAPI = {
            login: (email, password) => apiRequest('/auth/login/', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            }),
            register: (userData) => apiRequest('/auth/register/', {
                method: 'POST',
                body: JSON.stringify(userData)
            }),
            getProfile: () => apiRequest('/auth/profile/'),
            updateProfile: (userData) => apiRequest('/auth/profile/', {
                method: 'PUT',
                body: JSON.stringify(userData)
            })
        };

        // Modal Helper
        function createModal(content) {
            // Remove any existing modal
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal elements
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            
            const modalContainer = document.createElement('div');
            modalContainer.className = 'modal';
            
            // Set content
            modalContainer.innerHTML = content;
            
            // Add modal to overlay
            modalOverlay.appendChild(modalContainer);
            
            // Add overlay to body
            document.body.appendChild(modalOverlay);
            
            // Add close handlers
            const closeBtn = modalContainer.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => modalOverlay.remove());
            }
            
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) modalOverlay.remove();
            });
            
            modalContainer.addEventListener('click', (e) => e.stopPropagation());
            
            return { modalOverlay, modalContainer };
        }

        // Categories API
        const categoriesAPI = {
            list: () => apiRequest('/categories/'),
            create: (category) => apiRequest('/categories/', {
                method: 'POST',
                body: JSON.stringify(category)
            }),
            update: (id, category) => apiRequest(`/categories/${id}/`, {
                method: 'PUT',
                body: JSON.stringify(category)
            }),
            delete: (id) => apiRequest(`/categories/${id}/`, {
                method: 'DELETE'
            })
        };

        // Expenses API
        const expensesAPI = {
            list: (params = {}) => {
                const query = new URLSearchParams(params).toString();
                return apiRequest(`/expenses/?${query}`);
            },
            create: (expense) => apiRequest('/expenses/', {
                method: 'POST',
                body: JSON.stringify(expense)
            }),
            update: (id, expense) => apiRequest(`/expenses/${id}/`, {
                method: 'PUT',
                body: JSON.stringify(expense)
            }),
            delete: (id) => apiRequest(`/expenses/${id}/`, {
                method: 'DELETE'
            })
        };

        // Fixed Expenses API
        const fixedExpensesAPI = {
            list: () => apiRequest('/fixed-expenses/'),
            create: (expense) => apiRequest('/fixed-expenses/', {
                method: 'POST',
                body: JSON.stringify(expense)
            }),
            update: (id, expense) => apiRequest(`/fixed-expenses/${id}/`, {
                method: 'PUT',
                body: JSON.stringify(expense)
            }),
            delete: (id) => apiRequest(`/fixed-expenses/${id}/`, {
                method: 'DELETE'
            })
        };

        // Income API
        const incomeAPI = {
            get: () => apiRequest('/income/'),
            update: (income) => apiRequest('/income/', {
                method: 'PUT',
                body: JSON.stringify(income)
            }),
            listVariable: () => apiRequest('/income/variable/'),
            createVariable: (income) => apiRequest('/income/variable/', {
                method: 'POST',
                body: JSON.stringify(income)
            }),
            updateVariable: (id, income) => apiRequest(`/income/variable/${id}/`, {
                method: 'PUT',
                body: JSON.stringify(income)
            }),
            deleteVariable: (id) => apiRequest(`/income/variable/${id}/`, {
                method: 'DELETE'
            })
        };

        // Dashboard API
        const dashboardAPI = {
            stats: () => apiRequest('/dashboard/stats/'),
            recentTransactions: (limit = 10) => apiRequest(`/dashboard/recent-transactions/?limit=${limit}`),
            allTransactions: () => apiRequest('/dashboard/all-transactions/')
        };

        // Helper function to find category name
        function getCategoryName(expense, categories) {
            let categoryName = 'Sem categoria';

            if (expense.category_id) {
                const cat = categories.find(c => c.id === expense.category_id);
                if (cat) return cat.name;
            }

            if (expense.category_id) {
                const cat = categories.find(c => c.id == expense.category_id);
                if (cat) return cat.name;
            }

            if (expense.category) {
                if (typeof expense.category === 'object') {
                    return expense.category.name || 'Sem categoria';
                }
                return expense.category;
            }

            if (expense.categoryId) {
                const cat = categories.find(c => c.id == expense.categoryId);
                if (cat) return cat.name;
            }

            return categoryName;
        }

        // Loader functions
        function showLoader() {
            state.isLoading = true;
            const loader = document.createElement('div');
            loader.className = 'loader-overlay';
            loader.id = 'globalLoader';
            loader.innerHTML = '<div class="loader"></div>';
            document.body.appendChild(loader);
        }

        function hideLoader() {
            state.isLoading = false;
            const loader = document.getElementById('globalLoader');
            if (loader) {
                loader.remove();
            }
        }

        // App State
        const state = {
            isAuthenticated: false,
            currentUser: null,
            currentView: 'dashboard',
            sidebarOpen: false,
            isLoading: false,
            dashboardView: 'current' // 'current' or 'history'
        };

        // Initialize App
        function init() {
            const user = localStorage.getItem('currentUser');
            if (user) {
                state.currentUser = JSON.parse(user);
                state.isAuthenticated = true;
                renderApp();
            } else {
                renderLogin();
            }
        }

        // Render Login
        function renderLogin() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="login-container">
                    <div class="login-box">
                        <h2 id="loginTitle">Login</h2>
                        <form id="loginForm">
                            <div class="form-group hidden" id="nameGroup">
                                <label>Nome</label>
                                <input type="text" id="name">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="email" required placeholder="example@gmail.com">
                            </div>
                            <div class="form-group">
                                <label>Senha</label>
                                <input type="password" id="password" required placeholder="Digite sua senha...">
                            </div>
                            <div id="errorMessage" style="color: red; margin-bottom: 10px; display: none;"></div>
                            <button type="submit" class="btn" style="width: 100%; margin-bottom: 15px;">
                                <span id="submitText">Entrar</span>
                            </button>
                        </form>
                        <button id="toggleMode" style="background: none; border: none; color: #667eea; cursor: pointer; width: 100%; text-align: center;">
                            Não tem conta? Cadastre-se
                        </button>
                    </div>
                </div>
            `;

            let isRegister = false;
            const nameInput = document.getElementById('name');
            
            document.getElementById('toggleMode').addEventListener('click', () => {
                isRegister = !isRegister;
                document.getElementById('loginTitle').textContent = isRegister ? 'Cadastro' : 'Login';
                document.getElementById('submitText').textContent = isRegister ? 'Cadastrar' : 'Entrar';
                document.getElementById('toggleMode').textContent = isRegister ? 'Já tem conta? Faça login' : 'Não tem conta? Cadastre-se';
                document.getElementById('nameGroup').classList.toggle('hidden', !isRegister);
                
                if (isRegister) {
                    nameInput.setAttribute('required', '');
                } else {
                    nameInput.removeAttribute('required');
                    nameInput.value = '';
                }
            });

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const errorDiv = document.getElementById('errorMessage');
                const nameInput = document.getElementById('name');

                if (isRegister && !nameInput.value.trim()) {
                    errorDiv.textContent = 'Por favor, preencha o campo nome.';
                    errorDiv.style.display = 'block';
                    nameInput.focus();
                    return;
                }

                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;
                const name = nameInput.value;
                const submitBtn = e.target.querySelector('button[type="submit"]');

                submitBtn.disabled = true;
                errorDiv.style.display = 'none';

                try {
                    if (isRegister) {
                        await authAPI.register({ name, email, password });
                        const loginResponse = await authAPI.login(email, password);
                        localStorage.setItem('token', loginResponse.access_token);
                        const profile = await authAPI.getProfile();
                        handleLogin({ ...profile, token: loginResponse.access_token });
                    } else {
                        const response = await authAPI.login(email, password);
                        localStorage.setItem('token', response.access_token);
                        const profile = await authAPI.getProfile();
                        handleLogin({ ...profile, token: response.access_token });
                    }
                } catch (err) {
                    errorDiv.textContent = 'Erro no login/cadastro. Verifique suas credenciais.';
                    errorDiv.style.display = 'block';
                } finally {
                    submitBtn.disabled = false;
                }
            });
        }

        function handleLogin(userData) {
            localStorage.setItem('currentUser', JSON.stringify(userData));
            state.currentUser = userData;
            state.isAuthenticated = true;
            renderApp();
        }

        function handleLogout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('token');
            state.currentUser = null;
            state.isAuthenticated = false;
            state.currentView = 'dashboard';
            renderLogin();
        }

        // Render App
        function renderApp() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="app-container">
                    <button class="hamburger" id="hamburger">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    
                    <div class="sidebar" id="sidebar">
                        <div class="sidebar-header">
                            <img src="https://cdn-icons-png.flaticon.com/512/817/817729.png" alt="Logo FinControl" width="100" height="100">
                            <h2>FinControl</h2>
                        </div>
                        <button class="menu-item" data-view="dashboard">Dashboard</button>
                        <button class="menu-item" data-view="categories">Categorias</button>
                        <button class="menu-item" data-view="expenses">Lançamentos</button>
                        <button class="menu-item" data-view="fixedExpenses">Despesas Fixas</button>
                        <button class="menu-item" data-view="income">Receitas</button>
                        <button class="menu-item" data-view="reports">Relatórios</button>
                        <button class="menu-item" data-view="analysis">Análises</button>
                        <button class="menu-item" data-view="settings">Configurações</button>
                        <button class="menu-item" id="logoutBtn">Sair</button>
                    </div>
                    
                    <div class="main-content" id="mainContent"></div>
                </div>
            `;

            document.getElementById('hamburger').addEventListener('click', () => {
                state.sidebarOpen = !state.sidebarOpen;
                document.getElementById('sidebar').classList.toggle('active', state.sidebarOpen);
            });

            document.querySelectorAll('.menu-item[data-view]').forEach(btn => {
                btn.addEventListener('click', () => {
                    state.currentView = btn.dataset.view;
                    renderMainContent();
                    updateActiveMenu();
                    if (window.innerWidth <= 768) {
                        state.sidebarOpen = false;
                        document.getElementById('sidebar').classList.remove('active');
                    }
                });
            });

            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            updateActiveMenu();
            renderMainContent();
        }

        function updateActiveMenu() {
            document.querySelectorAll('.menu-item[data-view]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === state.currentView);
            });
        }

        function renderMainContent() {
            const content = document.getElementById('mainContent');
            
            switch(state.currentView) {
                case 'dashboard':
                    renderDashboard(content);
                    break;
                case 'categories':
                    renderCategories(content);
                    break;
                case 'expenses':
                    renderExpenses(content);
                    break;
                case 'fixedExpenses':
                    renderFixedExpenses(content);
                    break;
                case 'income':
                    renderIncome(content);
                    break;
                case 'reports':
                    renderReports(content);
                    break;
                case 'analysis':
                    renderAnalysis(content);
                    break;
                case 'settings':
                    renderSettings(content);
                    break;
            }
        }

        // Dashboard
        async function renderDashboard(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Dashboard</h1>
                <div style="margin-bottom: 20px;">
                    <button class="btn" id="currentMonthBtn" style="margin-right: 10px;">Mês Atual</button>
                    <button type="button" class="btn btn-success" id="historyBtn">Histórico Completo</button>
                </div>
                <div id="dashboardContent">Carregando...</div>
            `;

            // Set active button based on current view
            document.getElementById('currentMonthBtn').classList.toggle('btn', state.dashboardView === 'current');
            document.getElementById('currentMonthBtn').classList.toggle('btn-secondary', state.dashboardView !== 'current');
            document.getElementById('historyBtn').classList.toggle('btn', state.dashboardView === 'history');
            document.getElementById('historyBtn').classList.toggle('btn-secondary', state.dashboardView !== 'history');

            document.getElementById('currentMonthBtn').addEventListener('click', () => {
                state.dashboardView = 'current';
                renderDashboard(content);
            });

            document.getElementById('historyBtn').addEventListener('click', () => {
                state.dashboardView = 'history';
                renderDashboard(content);
            });

            showLoader();

            try {
                const [statsData, transactions] = await Promise.all([
                    dashboardAPI.stats(),
                    state.dashboardView === 'current' ? dashboardAPI.recentTransactions() : dashboardAPI.allTransactions()
                ]);

                const stats = {
                    total_balance: parseFloat(statsData.total_balance),
                    monthly_income: parseFloat(statsData.monthly_income),
                    monthly_expenses: parseFloat(statsData.monthly_expenses),
                    active_categories: statsData.active_categories,
                    transactions: transactions
                };

                const dashContent = document.getElementById('dashboardContent');
                dashContent.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>Saldo Total</h4>
                            <div class="value">R$ ${stats.total_balance.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Receita Mensal</h4>
                            <div class="value">R$ ${stats.monthly_income.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Despesas Mensal</h4>
                            <div class="value">R$ ${stats.monthly_expenses.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <h4>Categorias Ativas</h4>
                            <div class="value">${stats.active_categories}</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <h3>${state.dashboardView === 'current' ? 'Transações do Mês Atual' : 'Histórico Completo de Transações'}</h3>
                        ${stats.transactions.length > 0 ? `
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Descrição</th>
                                            <th>Tipo</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${stats.transactions.map(expense => `
                                            <tr>
                                                <td>${new Date(expense.date).toLocaleDateString('pt-BR')}</td>
                                                <td>${expense.description}</td>
                                                <td>
                                                    <span class="badge ${expense.type.toUpperCase() === 'RECEITA' ? 'badge-success' : 'badge-danger'}">
                                                        ${expense.type.toUpperCase()}
                                                    </span>
                                                </td>
                                                <td>R$ ${parseFloat(expense.amount).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="empty-state"><p>Nenhuma transação encontrada</p></div>'}
                    </div>
                `;
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
                document.getElementById('dashboardContent').innerHTML = '<p>Erro ao carregar dados do dashboard</p>';
            } finally {
                hideLoader();
            }
        }

        // Categories
        async function renderCategories(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Categorias</h1>
                <button class="btn" id="newCategoryBtn" style="margin-bottom: 20px;">Nova Categoria</button>
                <div class="dashboard-card">
                    <h3>Lista de Categorias</h3>
                    <div id="categoriesContent">Carregando...</div>
                </div>
            `;

            document.getElementById('newCategoryBtn').addEventListener('click', () => {
                console.log('Clicou em Nova Categoria');
                showCategoryModal();
            });

            showLoader();
            await loadCategories();
            hideLoader();
        }

        async function loadCategories() {
            try {
                const categories = await categoriesAPI.list();
                
                const categoriesContent = document.getElementById('categoriesContent');

                if (categories.length > 0) {
                    categoriesContent.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Tipo</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${categories.map(category => `
                                        <tr>
                                            <td>${category.name}</td>
                                            <td>
                                                <span class="badge ${category.type.toUpperCase() === 'RECEITA' ? 'badge-success' : 'badge-danger'}">
                                                    ${category.type.toUpperCase()}
                                                </span>
                                            </td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn btn-secondary" onclick="editCategory(${category.id}, '${category.name}', '${category.type.toUpperCase()}')">Editar</button>
                                                    <button class="btn btn-danger" onclick="deleteCategory(${category.id})">Excluir</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    categoriesContent.innerHTML = '<div class="empty-state"><p>Nenhuma categoria cadastrada</p></div>';
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                document.getElementById('categoriesContent').innerHTML = '<p>Erro ao carregar categorias</p>';
            }
        }

        function showCategoryModal(id = null, name = '', type = 'DESPESA') {
            console.log('Executando showCategoryModal');

            const content = `
                <div class="modal-header">
                    <h3>${id ? 'Editar Categoria' : 'Nova Categoria'}</h3>
                    <button class="close-btn">&times;</button>
                </div>
                <form id="categoryForm">
                    <div class="form-group">
                        <label>Nome da Categoria</label>
                        <input type="text" id="categoryName" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="categoryType">
                            <option value="DESPESA">Despesa</option>
                            <option value="RECEITA">Receita</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">${id ? 'Salvar' : 'Adicionar'}</button>
                </form>
            `;

            // Use helper to create and insert modal, and get references
            const { modalOverlay, modalContainer } = createModal(content);

            // Ensure the form inputs have their initial values (in case helper altered DOM)
            const nameInput = modalContainer.querySelector('#categoryName');
            const typeSelect = modalContainer.querySelector('#categoryType');
            if (nameInput) nameInput.value = name || '';
            if (typeSelect) typeSelect.value = type || 'DESPESA';

            // Form submit
            const form = modalContainer.querySelector('#categoryForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = {
                        name: modalContainer.querySelector('#categoryName').value,
                        type: modalContainer.querySelector('#categoryType').value
                    };

                    try {
                        if (id) {
                            await categoriesAPI.update(id, formData);
                        } else {
                            await categoriesAPI.create(formData);
                        }
                        modalOverlay.remove();
                        loadCategories();
                    } catch (error) {
                        console.error('Erro ao salvar categoria:', error);
                        alert('Erro ao salvar categoria');
                    }
                });
            }
        }

        window.editCategory = (id, name, type) => showCategoryModal(id, name, type);

        window.deleteCategory = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta categoria?')) {
                try {
                    await categoriesAPI.delete(id);
                    loadCategories();
                } catch (error) {
                    alert('Erro ao excluir categoria');
                }
            }
        };

        // Expenses
        async function renderExpenses(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Lançamentos</h1>
                <button class="btn" id="newExpenseBtn" style="margin-bottom: 20px;">Novo Lançamento</button>
                <div class="dashboard-card">
                    <h3>Lista de Lançamentos</h3>
                    <div id="expensesContent">Carregando...</div>
                </div>
            `;

            document.getElementById('newExpenseBtn').addEventListener('click', () => {
                console.log('Clicou em Novo Lançamento');
                showExpenseModal();
            });
            showLoader();
            await loadExpenses();
            hideLoader();
        }

        async function loadExpenses() {
            try {
                const [expenses, categories] = await Promise.all([
                    expensesAPI.list(),
                    categoriesAPI.list()
                ]);

                const expensesContent = document.getElementById('expensesContent');

                if (expenses.length > 0) {
                    expensesContent.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Data</th>
                                        <th>Descrição</th>
                                        <th>Categoria</th>
                                        <th>Tipo</th>
                                        <th>Valor</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${expenses.map(expense => {
                                        const categoryName = getCategoryName(expense, categories);
                                        
                                        return `
                                            <tr>
                                                <td>${new Date(expense.date).toLocaleDateString('pt-BR')}</td>
                                                <td>${expense.description}</td>
                                                <td>${categoryName}</td>
                                                <td>
                                                    <span class="badge ${expense.type.toUpperCase() === 'RECEITA' ? 'badge-success' : 'badge-danger'}">
                                                        ${expense.type.toUpperCase()}
                                                    </span>
                                                </td>
                                                <td>R$ ${parseFloat(expense.amount).toFixed(2)}</td>
                                                <td>
                                                    <div class="action-buttons">
                                                        <button class="btn btn-secondary" onclick="editExpense(${expense.id})">Editar</button>
                                                        <button class="btn btn-danger" onclick="deleteExpense(${expense.id})">Excluir</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    expensesContent.innerHTML = '<div class="empty-state"><p>Nenhum lançamento cadastrado</p></div>';
                }

                window.expensesData = expenses;
                window.categoriesData = categories;
            } catch (error) {
                console.error('Erro ao carregar expenses:', error);
                document.getElementById('expensesContent').innerHTML = '<p>Erro ao carregar lançamentos</p>';
            }
        }

        async function showExpenseModal(expenseData = null) {
            console.log('Executando showExpenseModal');

            const content = `
                <div class="modal-header">
                    <h3>${expenseData ? 'Editar Lançamento' : 'Novo Lançamento'}</h3>
                    <button class="close-btn">&times;</button>
                </div>
                <form id="expenseForm">
                    <div class="form-group">
                        <label>Descrição</label>
                        <input type="text" id="expenseDescription" required value="${expenseData?.description || ''}">
                    </div>
                    <div class="form-group">
                        <label>Valor</label>
                        <input type="number" step="0.01" id="expenseAmount" required value="${expenseData?.amount || ''}">
                    </div>
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="expenseType">
                            <option value="DESPESA" ${!expenseData || expenseData?.type === 'DESPESA' ? 'selected' : ''}>Despesa</option>
                            <option value="RECEITA" ${expenseData?.type === 'RECEITA' ? 'selected' : ''}>Receita</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="expenseCategory" required>
                            <option value="">Carregando categorias...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data</label>
                        <input type="date" id="expenseDate" required value="${expenseData?.date || new Date().toISOString().split('T')[0]}">
                    </div>
                    <button type="submit" class="btn">${expenseData ? 'Salvar' : 'Adicionar'}</button>
                </form>
            `;

            const { modalOverlay, modalContainer } = createModal(content);

            const typeSelect = modalContainer.querySelector('#expenseType');
            const categorySelect = modalContainer.querySelector('#expenseCategory');
            const dateInput = modalContainer.querySelector('#expenseDate');

            function updateCategories(categories) {
                const type = typeSelect.value;
                const filteredCategories = categories.filter(c => c.type.toUpperCase() === type);
                categorySelect.innerHTML = '<option value="">Selecione...</option>' +
                    filteredCategories.map(c => {
                        const selected = expenseData?.category_id == c.id ? 'selected' : '';
                        return `<option value="${c.id}" ${selected}>${c.name}</option>`;
                    }).join('');
            }

            typeSelect.addEventListener('change', () => {
                if (window.loadedCategories) {
                    updateCategories(window.loadedCategories);
                }
            });

            const form = modalContainer.querySelector('#expenseForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = {
                        description: modalContainer.querySelector('#expenseDescription').value,
                        amount: parseFloat(modalContainer.querySelector('#expenseAmount').value),
                        category_id: parseInt(modalContainer.querySelector('#expenseCategory').value),
                        date: modalContainer.querySelector('#expenseDate').value,
                        type: modalContainer.querySelector('#expenseType').value.toLowerCase()
                    };

                    try {
                        if (expenseData) {
                            await expensesAPI.update(expenseData.id, formData);
                        } else {
                            await expensesAPI.create(formData);
                        }
                        modalOverlay.remove();
                        loadExpenses();
                    } catch (error) {
                        console.error('Erro ao salvar:', error);
                        alert('Erro ao salvar lançamento');
                    }
                });
            }

            // Load categories
            try {
                const categories = await categoriesAPI.list();
                window.loadedCategories = categories;
                updateCategories(categories);
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                categorySelect.innerHTML = '<option value="">Erro ao carregar categorias</option>';
            }
        }

        window.editExpense = async (id) => {
            const expense = window.expensesData.find(e => e.id === id);
            if (expense) showExpenseModal(expense);
        };

        window.deleteExpense = async (id) => {
            if (confirm('Tem certeza que deseja excluir este lançamento?')) {
                try {
                    await expensesAPI.delete(id);
                    loadExpenses();
                } catch (error) {
                    alert('Erro ao excluir lançamento');
                }
            }
        };

        // Fixed Expenses
        async function renderFixedExpenses(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Despesas Fixas</h1>
                <button class="btn" id="newFixedExpenseBtn" style="margin-bottom: 20px;">Nova Despesa Fixa</button>
                <div class="dashboard-card">
                    <h3>Lista de Despesas Fixas</h3>
                    <div id="fixedExpensesContent">Carregando...</div>
                </div>
            `;

            document.getElementById('newFixedExpenseBtn').addEventListener('click', () => {
                console.log('Clicou em Nova Despesa Fixa');
                showFixedExpenseModal();
            });
            showLoader();
            await loadFixedExpenses();
            hideLoader();
        }

        async function loadFixedExpenses() {
            try {
                const [fixedExpenses, categories] = await Promise.all([
                    fixedExpensesAPI.list(),
                    categoriesAPI.list()
                ]);

                const expensesContent = document.getElementById('fixedExpensesContent');
                
                if (!expensesContent) {
                    console.error('Elemento fixedExpensesContent não encontrado');
                    return;
                }

                if (fixedExpenses.length > 0) {
                    expensesContent.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Descrição</th>
                                        <th>Categoria</th>
                                        <th>Valor</th>
                                        <th>Dia do Mês</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${fixedExpenses.map(expense => {
                                        const categoryName = getCategoryName(expense, categories);
                                        
                                        return `
                                            <tr>
                                                <td>${expense.description}</td>
                                                <td>${categoryName}</td>
                                                <td>R$ ${parseFloat(expense.amount).toFixed(2)}</td>
                                                <td>Dia ${expense.day_of_month}</td>
                                                <td>
                                                    <div class="action-buttons">
                                                        <button class="btn btn-secondary" onclick="editFixedExpense(${expense.id})">Editar</button>
                                                        <button class="btn btn-danger" onclick="deleteFixedExpense(${expense.id})">Excluir</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    expensesContent.innerHTML = '<div class="empty-state"><p>Nenhuma despesa fixa cadastrada</p></div>';
                }

                window.fixedExpensesData = fixedExpenses;
                window.fixedCategoriesData = categories;
            } catch (error) {
                console.error('Erro ao carregar despesas fixas:', error);
                const expensesContent = document.getElementById('fixedExpensesContent');
                if (expensesContent) {
                    expensesContent.innerHTML = '<p>Erro ao carregar despesas fixas</p>';
                }
            }
        }

        async function showFixedExpenseModal(expenseData = null) {
            console.log('Executando showFixedExpenseModal');

            const content = `
                <div class="modal-header">
                    <h3>${expenseData ? 'Editar Despesa Fixa' : 'Nova Despesa Fixa'}</h3>
                    <button class="close-btn">&times;</button>
                </div>
                <form id="fixedExpenseForm">
                    <div class="form-group">
                        <label>Descrição</label>
                        <input type="text" id="fixedExpenseDescription" required value="${expenseData?.description || ''}">
                    </div>
                    <div class="form-group">
                        <label>Valor</label>
                        <input type="number" step="0.01" id="fixedExpenseAmount" required value="${expenseData?.amount || ''}">
                    </div>
                    <div class="form-group">
                        <label>Categoria</label>
                        <select id="fixedExpenseCategory" required>
                            <option value="">Carregando categorias...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Dia do Mês (1-31)</label>
                        <input type="number" min="1" max="31" id="fixedExpenseDay" required value="${expenseData?.day_of_month || ''}">
                    </div>
                    <button type="submit" class="btn">${expenseData ? 'Salvar' : 'Adicionar'}</button>
                </form>
            `;

            const { modalOverlay, modalContainer } = createModal(content);

            const form = modalContainer.querySelector('#fixedExpenseForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = {
                        description: modalContainer.querySelector('#fixedExpenseDescription').value,
                        amount: parseFloat(modalContainer.querySelector('#fixedExpenseAmount').value),
                        category_id: parseInt(modalContainer.querySelector('#fixedExpenseCategory').value),
                        day_of_month: parseInt(modalContainer.querySelector('#fixedExpenseDay').value)
                    };

                    try {
                        if (expenseData) {
                            await fixedExpensesAPI.update(expenseData.id, formData);
                        } else {
                            await fixedExpensesAPI.create(formData);
                        }
                        modalOverlay.remove();
                        loadFixedExpenses();
                    } catch (error) {
                        console.error('Erro ao salvar:', error);
                        alert('Erro ao salvar despesa fixa');
                    }
                });
            }

            // Load categories
            try {
                const categories = await categoriesAPI.list();
                const despesaCategories = categories.filter(c => c.type.toUpperCase() === 'DESPESA');
                const categorySelect = modalContainer.querySelector('#fixedExpenseCategory');
                categorySelect.innerHTML = '<option value="">Selecione...</option>' +
                    despesaCategories.map(c => {
                        const selected = expenseData?.category_id == c.id ? 'selected' : '';
                        return `<option value="${c.id}" ${selected}>${c.name}</option>`;
                    }).join('');
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                const categorySelect = modalContainer.querySelector('#fixedExpenseCategory');
                if (categorySelect) categorySelect.innerHTML = '<option value="">Erro ao carregar categorias</option>';
            }
        }

        window.editFixedExpense = (id) => {
            const expense = window.fixedExpensesData.find(e => e.id === id);
            if (expense) showFixedExpenseModal(expense);
        };

        window.deleteFixedExpense = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta despesa fixa?')) {
                try {
                    await fixedExpensesAPI.delete(id);
                    loadFixedExpenses();
                } catch (error) {
                    alert('Erro ao excluir despesa fixa');
                }
            }
        };

        // Income
        async function renderIncome(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Receitas</h1>
                <div id="incomeContent">Carregando...</div>
            `;

            showLoader();
            await loadIncome();
            hideLoader();
        }

        async function loadIncome() {
            try {
                const [incomeData, variableIncomes] = await Promise.all([
                    incomeAPI.get(),
                    incomeAPI.listVariable()
                ]);

                const totalVariable = variableIncomes.reduce((sum, v) => sum + parseFloat(v.amount), 0);
                const totalIncome = parseFloat(incomeData.fixed_amount) + totalVariable;

                const incomeContent = document.getElementById('incomeContent');
                incomeContent.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>Receita Total Líquida</h4>
                            <div class="value">R$ ${totalIncome.toFixed(2)}</div>
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <h3>Receita Mensal Fixa</h3>
                        <div class="form-group">
                            <label>Valor Fixo Mensal</label>
                            <input type="number" step="0.01" id="fixedIncomeInput" value="${incomeData.fixed_amount}" placeholder="0.00">
                        </div>
                    </div>

                    <div class="dashboard-card">
                        <h3>Receitas Variáveis</h3>
                        <button class="btn" id="newVariableIncomeBtn" style="margin-bottom: 20px;">Adicionar Receita Variável</button>
                        <div id="variableIncomesContent"></div>
                    </div>
                `;

                let debounceTimer;
                document.getElementById('fixedIncomeInput').addEventListener('input', (e) => {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(async () => {
                        try {
                            await incomeAPI.update({
                                fixed_amount: parseFloat(e.target.value) || 0,
                                bonus_amount: incomeData.bonus_amount || 0
                            });
                            loadIncome();
                        } catch (error) {
                            alert('Erro ao atualizar receita fixa');
                        }
                    }, 1000);
                });

                document.getElementById('newVariableIncomeBtn').addEventListener('click', () => showVariableIncomeModal());

                const variableContent = document.getElementById('variableIncomesContent');
                if (variableIncomes.length > 0) {
                    variableContent.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Descrição</th>
                                        <th>Valor</th>
                                        <th>Válido Até</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${variableIncomes.map(variable => `
                                        <tr>
                                            <td>${variable.description}</td>
                                            <td>R$ ${parseFloat(variable.amount).toFixed(2)}</td>
                                            <td>${variable.valid_until ? new Date(variable.valid_until).toLocaleDateString('pt-BR') : 'Indefinido'}</td>
                                            <td>
                                                <div class="action-buttons">
                                                    <button class="btn btn-secondary" onclick="editVariableIncome(${variable.id})">Editar</button>
                                                    <button class="btn btn-danger" onclick="deleteVariableIncome(${variable.id})">Excluir</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    variableContent.innerHTML = '<div class="empty-state"><p>Nenhuma receita variável cadastrada</p></div>';
                }

                window.variableIncomesData = variableIncomes;
            } catch (error) {
                console.error('Erro ao carregar receitas:', error);
                document.getElementById('incomeContent').innerHTML = '<p>Erro ao carregar receitas</p>';
            }
        }

        function showVariableIncomeModal(incomeData = null) {
            const content = `
                <div class="modal-header">
                    <h3>${incomeData ? 'Editar Receita Variável' : 'Nova Receita Variável'}</h3>
                    <button class="close-btn">&times;</button>
                </div>
                <form id="variableIncomeForm">
                    <div class="form-group">
                        <label>Descrição</label>
                        <input type="text" id="variableIncomeDescription" required value="${incomeData?.description || ''}">
                    </div>
                    <div class="form-group">
                        <label>Valor</label>
                        <input type="number" step="0.01" id="variableIncomeAmount" required value="${incomeData?.amount || ''}">
                    </div>
                    <div class="form-group">
                        <label>Válido Até</label>
                        <input type="date" id="variableIncomeValidUntil" value="${incomeData?.valid_until || ''}">
                    </div>
                    <button type="submit" class="btn">${incomeData ? 'Salvar' : 'Adicionar'}</button>
                </form>
            `;

            const { modalOverlay, modalContainer } = createModal(content);

            const form = modalContainer.querySelector('#variableIncomeForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = {
                        description: modalContainer.querySelector('#variableIncomeDescription').value,
                        amount: parseFloat(modalContainer.querySelector('#variableIncomeAmount').value),
                        valid_until: modalContainer.querySelector('#variableIncomeValidUntil').value,
                        is_active: true
                    };

                    try {
                        if (incomeData) {
                            await incomeAPI.updateVariable(incomeData.id, formData);
                        } else {
                            await incomeAPI.createVariable(formData);
                        }
                        modalOverlay.remove();
                        loadIncome();
                    } catch (error) {
                        console.error('Erro ao salvar receita variável:', error);
                        alert('Erro ao salvar receita variável');
                    }
                });
            }
        }

        window.editVariableIncome = (id) => {
            const income = window.variableIncomesData.find(i => i.id === id);
            if (income) showVariableIncomeModal(income);
        };

        window.deleteVariableIncome = async (id) => {
            if (confirm('Tem certeza que deseja excluir esta receita variável?')) {
                try {
                    await incomeAPI.deleteVariable(id);
                    loadIncome();
                } catch (error) {
                    alert('Erro ao excluir receita variável');
                }
            }
        };

        // Reports
        async function renderReports(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Relatórios</h1>

                <div class="dashboard-card">
                    <h3>Configurações do Relatório</h3>
                    <div class="filter-container">
                        <select id="reportType">
                            <option value="mensal">Mensal</option>
                            <option value="anual">Anual</option>
                            <option value="personalizado">Período Personalizado</option>
                        </select>
                        <select id="categoryFilter">
                            <option value="all">Todas as Categorias</option>
                        </select>
                        <input type="date" id="startDate" placeholder="Data de início" style="display: none;">
                        <input type="date" id="endDate" placeholder="Data de fim" style="display: none;">
                        <button class="btn" id="generateReportBtn">Gerar Relatório</button>
                    </div>
                </div>

                <div id="reportContent"></div>
            `;

            showLoader();
            try {
                const categories = await categoriesAPI.list();
                const categoryFilter = document.getElementById('categoryFilter');
                categories.forEach(cat => {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    categoryFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            } finally {
                hideLoader();
            }

            // Event listener para mostrar/ocultar campos de data
            document.getElementById('reportType').addEventListener('change', function() {
                const reportType = this.value;
                const startDateInput = document.getElementById('startDate');
                const endDateInput = document.getElementById('endDate');

                if (reportType === 'personalizado') {
                    startDateInput.style.display = 'block';
                    endDateInput.style.display = 'block';
                    startDateInput.required = true;
                    endDateInput.required = true;
                } else {
                    startDateInput.style.display = 'none';
                    endDateInput.style.display = 'none';
                    startDateInput.required = false;
                    endDateInput.required = false;
                    startDateInput.value = '';
                    endDateInput.value = '';
                }
            });

            document.getElementById('generateReportBtn').addEventListener('click', generateReport);
        }

        async function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const reportContent = document.getElementById('reportContent');

            reportContent.innerHTML = '<div class="dashboard-card"><p>Gerando relatório...</p></div>';
            showLoader();

            try {
                const [expenses, categories, incomeData, variableIncomes, fixedExpenses] = await Promise.all([
                    expensesAPI.list(),
                    categoriesAPI.list(),
                    incomeAPI.get(),
                    incomeAPI.listVariable(),
                    fixedExpensesAPI.list()
                ]);

                const now = new Date();
                let filteredExpenses = expenses;

                if (reportType === 'mensal') {
                    filteredExpenses = expenses.filter(e => {
                        const date = new Date(e.date);
                        return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                    });
                } else if (reportType === 'anual') {
                    filteredExpenses = expenses.filter(e => {
                        const date = new Date(e.date);
                        return date.getFullYear() === now.getFullYear();
                    });
                } else if (reportType === 'personalizado') {
                    if (!startDate || !endDate) {
                        alert('Por favor, selecione as datas de início e fim.');
                        hideLoader();
                        return;
                    }
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    filteredExpenses = expenses.filter(e => {
                        const date = new Date(e.date);
                        return date >= start && date <= end;
                    });
                }

                if (categoryFilter !== 'all') {
                    filteredExpenses = filteredExpenses.filter(e => e.category_id === parseInt(categoryFilter));
                }

                // Calcular total de despesas dos lançamentos
                const totalExpensesFromLancamentos = filteredExpenses.reduce((sum, e) => 
                    e.type.toUpperCase() === 'DESPESA' ? sum + parseFloat(e.amount) : sum, 0);
                
                // Calcular total de despesas fixas (considerar apenas para relatório mensal)
                let totalFixedExpenses = 0;
                let fixedExpensesToShow = [];
                
                if (reportType === 'mensal') {
                    totalFixedExpenses = fixedExpenses.reduce((sum, e) => sum + parseFloat(e.amount), 0);
                    fixedExpensesToShow = fixedExpenses;
                }
                
                // Total de despesas = lançamentos + despesas fixas
                const totalExpenses = totalExpensesFromLancamentos + totalFixedExpenses;
                
      
                
                const totalIncomeFromExpenses = filteredExpenses.reduce((sum, e) => 
                    e.type.toUpperCase() === 'RECEITA' ? sum + parseFloat(e.amount) : sum, 0);

                const totalVariableIncome = variableIncomes.reduce((sum, v) => 
                    sum + parseFloat(v.amount), 0);
                
                const totalIncome = parseFloat(incomeData.fixed_amount) + totalVariableIncome + totalIncomeFromExpenses;
                const balance = totalIncome - totalExpenses;

                let period;
                if (reportType === 'mensal') {
                    period = now.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                } else if (reportType === 'anual') {
                    period = now.getFullYear();
                } else if (reportType === 'personalizado') {
                    period = `${new Date(startDate).toLocaleDateString('pt-BR')} - ${new Date(endDate).toLocaleDateString('pt-BR')}`;
                }

                reportContent.innerHTML = `
                    <div class="dashboard-card">
                        <h3>Relatório ${reportType === 'mensal' ? 'Mensal' : 'Anual'} - ${period}</h3>
                        
                        <div class="stats-grid" style="margin-bottom: 30px;">
                            <div class="stat-card">
                                <h4>Receita Total</h4>
                                <div class="value">R$ ${totalIncome.toFixed(2)}</div>
                            </div>
                            <div class="stat-card">
                                <h4>Despesas de Lançamentos</h4>
                                <div class="value">R$ ${totalExpensesFromLancamentos.toFixed(2)}</div>
                            </div>
                            ${reportType === 'mensal' ? `
                                <div class="stat-card">
                                    <h4>Despesas Fixas</h4>
                                    <div class="value">R$ ${totalFixedExpenses.toFixed(2)}</div>
                                </div>
                            ` : ''}
                            <div class="stat-card">
                                <h4>Despesas Total</h4>
                                <div class="value">R$ ${totalExpenses.toFixed(2)}</div>
                            </div>
                            <div class="stat-card">
                                <h4>Saldo</h4>
                                <div class="value" style="color: ${balance >= 0 ? '#28a745' : '#dc3545'}">
                                    R$ ${balance.toFixed(2)}
                                </div>
                            </div>
                        </div>

                        ${reportType === 'mensal' && fixedExpensesToShow.length > 0 ? `
                            <div style="margin-bottom: 30px;">
                                <h4 style="color: #333; margin-bottom: 15px;">Despesas Fixas do Mês</h4>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Descrição</th>
                                                <th>Categoria</th>
                                                <th>Valor</th>
                                                <th>Dia do Mês</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${fixedExpensesToShow.map(expense => {
                                                const categoryName = getCategoryName(expense, categories);
                                                return `
                                                    <tr>
                                                        <td>${expense.description}</td>
                                                        <td>${categoryName}</td>
                                                        <td>R$ ${parseFloat(expense.amount).toFixed(2)}</td>
                                                        <td>Dia ${expense.day_of_month}</td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                            <tr style="font-weight: bold; background: #f8f9fa;">
                                                <td colspan="2">Total Despesas Fixas</td>
                                                <td>R$ ${totalFixedExpenses.toFixed(2)}</td>
                                                <td></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ` : ''}

                        <div class="action-buttons" style="margin-bottom: 20px;">
                            <button class="btn btn-success" id="downloadPdfBtn">Baixar PDF</button>
                            <button class="btn" id="sendEmailBtn">Enviar por Email</button>
                        </div>

                        ${filteredExpenses.length > 0 ? `
                            <h4 style="color: #333; margin-bottom: 15px;">Lançamentos do Período</h4>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Data</th>
                                            <th>Descrição</th>
                                            <th>Categoria</th>
                                            <th>Tipo</th>
                                            <th>Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${filteredExpenses.map(expense => {
                                            const categoryName = getCategoryName(expense, categories);
                                            
                                            return `
                                                <tr>
                                                    <td>${new Date(expense.date).toLocaleDateString('pt-BR')}</td>
                                                    <td>${expense.description}</td>
                                                    <td>${categoryName}</td>
                                                    <td>
                                                        <span class="badge ${expense.type.toUpperCase() === 'RECEITA' ? 'badge-success' : 'badge-danger'}">
                                                            ${expense.type.toUpperCase()}
                                                        </span>
                                                    </td>
                                                    <td>R$ ${parseFloat(expense.amount).toFixed(2)}</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : '<div class="empty-state"><p>Nenhum lançamento encontrado para este período</p></div>'}
                    </div>
                `;

                document.getElementById('downloadPdfBtn').addEventListener('click', () => {
                    downloadReportPDF({
                        period,
                        reportType,
                        totalIncome,
                        totalExpenses,
                        totalExpensesFromLancamentos,
                        totalFixedExpenses,
                        balance,
                        expenses: filteredExpenses,
                        fixedExpenses: fixedExpensesToShow,
                        categories
                    });
                });

                document.getElementById('sendEmailBtn').addEventListener('click', () => {
                    alert('Funcionalidade de envio por email será implementada com o backend');
                });

            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                reportContent.innerHTML = '<div class="dashboard-card"><p style="color: red;">Erro ao gerar relatório</p></div>';
            } finally {
                hideLoader();
            }
        }

        function downloadReportPDF(reportData) {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('Relatorio Financeiro', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Periodo: ${reportData.period}`, 20, 35);
                doc.text(`Receita Total: R$ ${reportData.totalIncome.toFixed(2)}`, 20, 45);
                doc.text(`Despesas Total: R$ ${reportData.totalExpenses.toFixed(2)}`, 20, 55);
                doc.text(`Saldo: R$ ${reportData.balance.toFixed(2)}`, 20, 65);
                
                let y = 80;
                
                if (reportData.fixedExpenses && reportData.fixedExpenses.length > 0) {
                    doc.text('Despesas Fixas:', 20, y);
                    y += 10;
                    
                    reportData.fixedExpenses.forEach(expense => {
                        const categoryName = getCategoryName(expense, reportData.categories);
                        const line = `${expense.description} (${categoryName}): R$ ${parseFloat(expense.amount).toFixed(2)}`;
                        
                        if (y > 280) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.text(line, 20, y);
                        y += 7;
                    });
                    
                    y += 10;
                }
                
                doc.text('Lancamentos:', 20, y);
                y += 10;
                
                reportData.expenses.forEach(expense => {
                    const categoryName = getCategoryName(expense, reportData.categories);
                    const line = `${new Date(expense.date).toLocaleDateString('pt-BR')} - ${expense.description} (${categoryName}): R$ ${parseFloat(expense.amount).toFixed(2)}`;
                    
                    if (line.length > 80) {
                        const lines = doc.splitTextToSize(line, 170);
                        lines.forEach(l => {
                            if (y > 280) {
                                doc.addPage();
                                y = 20;
                            }
                            doc.text(l, 20, y);
                            y += 7;
                        });
                    } else {
                        if (y > 280) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.text(line, 20, y);
                        y += 10;
                    }
                });
                
                doc.save(`relatorio-${reportData.reportType}-${Date.now()}.pdf`);
                alert('PDF baixado com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF. Verifique se a biblioteca jsPDF esta carregada.');
            }
        }

        // Analysis
        function renderAnalysis(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Análises</h1>
                <div class="dashboard-card">
                    <h3>Em desenvolvimento</h3>
                    <p>Funcionalidade de análises será implementada em breve.</p>
                </div>
            `;
        }

        // Settings
        function renderSettings(content) {
            content.innerHTML = `
                <h1 style="color: #333; margin-bottom: 30px;">Configurações</h1>

                <div class="dashboard-card">
                    <h3>Perfil do Usuário</h3>
                    <div class="profile-section">
                        <div class="profile-avatar">
                            ${state.currentUser?.name?.charAt(0).toUpperCase() || 'U'}
                        </div>
                        <div style="flex: 1;">
                            <h2 style="color: #333; margin-bottom: 10px;">${state.currentUser?.name || 'Usuário'}</h2>
                            <p style="color: #666;">${state.currentUser?.email || 'email@exemplo.com'}</p>
                        </div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <h3>Editar Informações</h3>
                    <form id="settingsForm">
                        <div class="form-group">
                            <label>Nome</label>
                            <input type="text" id="settingsName" value="${state.currentUser?.name || ''}">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="settingsEmail" value="${state.currentUser?.email || ''}">
                        </div>
                        <div class="form-group">
                            <label>Nova Senha (deixe em branco para manter a atual)</label>
                            <input type="password" id="settingsPassword" placeholder="Nova senha">
                        </div>
                        <button type="submit" class="btn">Salvar Alterações</button>
                    </form>
                </div>
            `;

            document.getElementById('settingsForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoader();

                try {
                    const updatedUser = {
                        ...state.currentUser,
                        name: document.getElementById('settingsName').value,
                        email: document.getElementById('settingsEmail').value
                    };

                    // Simular atualização no backend
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                    state.currentUser = updatedUser;
                    alert('Configurações salvas com sucesso!');
                    renderSettings(content);
                } catch (error) {
                    alert('Erro ao salvar configurações');
                } finally {
                    hideLoader();
                }
            });
        }

        // Initialize
        init();
    </script>
    <footer >
        Todos os Direitos reservados © Desenvolvido por <a href="https://karythongomes.com.br" target="_blank" rel="noopener noreferrer"><strong>GomesTechnology</strong></a>
    </footer>
</body>
</html>